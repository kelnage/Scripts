// ==UserScript==
// @name rhBLAEO
// @namespace revilheart
// @author revilheart
// @description Adds some cool features to BLAEO.
// @version 1.1
// @match http://backlog-deepness.rhcloud.com/*
// @match https://backlog-deepness.rhcloud.com/*
// @grant GM_xmlhttpRequest
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_deleteValue
// @connect api.steampowered.com
// @run-at document-idle
// ==/UserScript==

var a;a={Features:{TLC:{Name:"Theme List Checker",Enabled:true}},Storage:{SteamAPIKey:"",SteamID:"",Username:"?",OwnedGames:[],LastSync:"",TLCList:"",TLCGames:[]}};if(GM_getValue("rhBLAEO"))a=GM_getValue("rhBLAEO");else GM_setValue("rhBLAEO",a);if(a.Storage.APIKey){a.Storage.SteamAPIKey=a.Storage.APIKey;delete a.Storage.APIKey;}if(a.Storage.UserID){a.Storage.Username=a.Storage.UserID;delete a.Storage.UserID;}if(window.location.href.match("/settings/"))b();if(a.Storage.SteamAPIKey)c();document.addEventListener("turbolinks:load",function(){if(window.location.href.match("/settings/"))b();if(a.Storage.SteamAPIKey)c();});function b(){var ba,bc;ba=document.getElementsByClassName("nav-pills")[0];ba.insertAdjacentHTML("beforeend","<li id=\"SMButton\"><a href=\"#rhBLAEO\">rhBLAEO</a></li>");bc=document.getElementById("SMButton");bc.addEventListener("click",function(){window.location.hash="#rhBLAEO";bd();});if(window.location.href.match("#rhBLAEO"))bd();function bd(){var bda,bdb,bdc,bdd;ba.getElementsByClassName("active")[0].classList.remove("active");bc.classList.add("active");document.getElementsByClassName("col-sm-9")[0].innerHTML="<div class=\"form-group\"><label class=\"control-label\">Steam API Key</label><input class=\"form-control\" id=\"SMSteamAPIKey\" type=\"text\" value=\""+a.Storage.SteamAPIKey+"\" style=\"margin: 0 0 10px;\"><div><button class=\"btn btn-primary\" id=\"SMSave\" type=\"submit\">Save</button></div></div><div class=\"form-group\"><label class=\"control=label\">Sync</label><p>Your current username is <b id=\"SMUsername\">"+a.Storage.Username+"</b> and you have <b id=\"SMOwnedGames\">"+a.Storage.OwnedGames.length+"</b> games in your library, right?</p><p><i>Last synced <span id=\"SMLastSync\"></span>.</i></p><div><button class=\"btn btn-primary\" id=\"SMSync\" type=\"submit\">Sync</button></div></div>";bda=document.getElementById("SMSteamAPIKey");bdb=document.getElementById("SMSave");bdb.addEventListener("click",function(){a.Storage.SteamAPIKey=bda.value;bde(bdf);});bdc=document.getElementById("SMLastSync");bdc.textContent=a.Storage.LastSync?(new Date(a.Storage.LastSync)).toLocaleString():"never";bdd=document.getElementById("SMSync");bdd.addEventListener("click",bdf);function bde(bdea){bdb.textContent="Saving...";if(a.Storage.Username=="?")a.Storage.Username=document.getElementsByClassName("navbar-btn")[0].href.split("/users/")[1];if(!a.Storage.SteamID){GM_xmlhttpRequest({method:"GET",url:"/users/"+a.Storage.Username,onload:function(bdeb){a.Storage.SteamID=(new DOMParser()).parseFromString(bdeb.responseText,"text/html").getElementsByClassName("btn-profile")[0].href.split("/profiles/")[1];bdb.textContent="Save";bdea();}});}else{bdb.textContent="Save";bdea();}}function bdf(){bdd.textContent="Syncing...";be(function(){document.getElementById("SMUsername").textContent=a.Storage.Username;document.getElementById("SMOwnedGames").textContent=a.Storage.OwnedGames.length;bdc.textContent=(new Date(a.Storage.LastSync)).toLocaleString();bdd.textContent="Sync";});}}}function be(bea){a.Storage.Username=document.getElementsByClassName("navbar-btn")[0].href.split("/users/")[1];a.Storage.OwnedGames=[];GM_xmlhttpRequest({method:"GET",url:"http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key="+a.Storage.SteamAPIKey+"&steamid="+a.Storage.SteamID+"&format=json",onload:function(beb){var bec,bed;bed=JSON.parse(beb.responseText).response.games;bec=bed.length-1;while(bec>=0)a.Storage.OwnedGames.push(bed[bec--].appid);a.Storage.LastSync=(new Date()).getTime();GM_setValue("rhBLAEO",a);bea();}});}function c(){if(!a.Storage.TLCList)ca();if(window.location.href.match(a.Storage.TLCList))cb();}function ca(){var caa,cab;caa=new Date();caa=caa.getMonth()+1<10?caa.getFullYear()+"-0"+(caa.getMonth()+1):caa.getFullYear()+"-"+(caa.getMonth()+1);GM_xmlhttpRequest({method:"GET",url:"/themes/"+caa,onload:function(cac){cab=(new DOMParser()).parseFromString(cac.responseText,"text/html").querySelector("[id*='theme-list']");if(cab){a.Storage.TLCList=cab.href.split("/posts/")[1];GM_setValue("rhBLAEO",a);}}});}function cb(){var cba,cbb,cbc;cbb=document.getElementsByClassName("panel-default")[0].getElementsByTagName("ul")[0].children;cba=cbb.length-1;while(cba>=0){cbc=parseInt(cbb[cba].firstElementChild.href.match(/\d+/)[0]);if(a.Storage.TLCGames.indexOf(cbc)<0){a.Storage.TLCGames.push(cbc);cd(cbb[cba]);if(a.Storage.OwnedGames.indexOf(cbc)>=0)cc(cbb[cba]);}else if(a.Storage.OwnedGames.indexOf(cbc)>=0)cc(cbb[cba]);--cba;}ce(cbb,"Beaten","rgb(92 ,184, 92)",function(){ce(cbb,"Completed","rgb(91, 192, 222)",function(){document.querySelector("[id*='counter']").innerHTML="<font size=\"4\"><b>"+cbb.length+" Games</b></font>";GM_setValue("rhBLAEO",a);});});}function cc(cca){cca.insertAdjacentHTML("beforeend","<b style=\"color: rgb(217, 83, 79);\"> [Owned]</b>");}function cd(cda){cda.insertAdjacentHTML("beforeend","<b style=\"color: rgb(85, 85, 85);\"> [New]</b>");}function ce(cea,ceb,cec,ced){GM_xmlhttpRequest({method:"GET",url:"/users/"+a.Storage.Username+"/games/"+ceb.toLowerCase(),onload:function(cee){var cef,ceg;cef = cea.length - 1;while(cef>=0){ceg=cea[cef].firstElementChild.href.match(/\d+/)[0];if((new RegExp("/app/"+ceg)).exec(cee.responseText))cea[cef].insertAdjacentHTML("beforeend","<b style=\"color: "+cec+";\"> ["+ceb+"]</b>");--cef;}ced();}});}
