// ==UserScript==
// @name rhBLAEO
// @namespace revilheart
// @author revilheart
// @description Adds some cool features to BLAEO.
// @version 1.0
// @match http://backlog-deepness.rhcloud.com/*
// @match https://backlog-deepness.rhcloud.com/*
// @grant GM_xmlhttpRequest
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_deleteValue
// @run-at document-idle
// ==/UserScript==

var a;a={Features:{TLC:{Name:"Theme List Checker",Enabled:true}},Storage:{TLCList:null,TLCGames:[],UserID:null,SteamID:null,APIKey:null,OwnedGames:null}};if(GM_getValue("rhBLAEO"))a=GM_getValue("rhBLAEO");else GM_setValue("rhBLAEO",a);if(window.location.href.match("/settings/"))b();if(a.Storage.APIKey)c();document.addEventListener("turbolinks:load",function(){if(window.location.href.match("/settings/"))b();if(a.Storage.APIKey)c();});function b(){var b1,b2;b1=document.getElementsByClassName("nav-pills")[0];b1.insertAdjacentHTML("beforeend","<li><a href=\"#rhBLAEO\">rhBLAEO</a></li>");b2=b1.lastElementChild;b2.addEventListener("click",function(){window.location.hash="#rhBLAEO";b3();});if(window.location.href.match("#rhBLAEO"))b3();function b3(){var b4,b5,b6;b1.getElementsByClassName("active")[0].classList.remove("active");b2.classList.add("active");b4=document.getElementsByClassName("col-sm-9")[0];b4.innerHTML="<div class=\"form-group\"><label class=\"control-label\">API Key</label><input class=\"form-control\" type=\"text\"></div><div><button class=\"btn btn-primary\" type=\"submit\">Save</button></div>";b5=b4.firstElementChild.lastElementChild;if (a.Storage.APIKey)b5.value=a.Storage.APIKey;b6=b4.lastElementChild.firstElementChild;b6.addEventListener("click",function(){a.Storage.APIKey=b5.value;GM_setValue("rhBLAEO",a);window.location.reload();});}}function c(){if(!a.Storage.UserID){a.Storage.UserID=document.getElementsByClassName("navbar-btn")[0].href.split("/users/")[1];GM_setValue("rhBLAEO",a);}if(!a.Storage.SteamID){GM_xmlhttpRequest({method:"GET",url:"/users/"+a.Storage.UserID,onload:function(ca){a.Storage.SteamID=(new DOMParser()).parseFromString(ca.responseText,"text/html").getElementsByClassName("btn-profile")[0].href.split("/profiles/")[1];GM_setValue("rhBLAEO",a);if(!a.Storage.OwnedGames)c1(function(){if(!a.Storage.TLCList)c2(function(){if(window.location.href.match(a.Storage.TLCList))c3();});else if(window.location.href.match(a.Storage.TLCList))c3();});else if (!a.Storage.TLCList)c2(function(){if (window.location.href.match(a.Storage.TLCList))c3();});else if (window.location.href.match(a.Storage.TLCList))c3();}});}else if(!a.Storage.OwnedGames)c1(function(){if(!a.Storage.TLCList)c2(function(){if(window.location.href.match(a.Storage.TLCList))c3();});else if(window.location.href.match(a.Storage.TLCList))c3();});else if(!a.Storage.TLCList)c2(function(){if(window.location.href.match(a.Storage.TLCList))c3();});else if(window.location.href.match(a.Storage.TLCList))c3();}function c1(ca){var cb,cc,cd;a.Storage.OwnedGames=[];GM_xmlhttpRequest({method:"GET",url:"http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key="+a.Storage.APIKey+"&steamid="+a.Storage.SteamID+"&format=json",onload:function(ce){cd=JSON.parse(ce.responseText).response.games;for(cb=0,cc=cd.length;cb<cc;++cb){a.Storage.OwnedGames.push(cd[cb].appid);}GM_setValue("rhBLAEO",a);ca();}});}function c2(ca){var cb,cc;cb=new Date();if(cb.getMonth()+1<10)cb=cb.getFullYear()+"-0"+(cb.getMonth()+1);else cb=cb.getFullYear()+"-"+(cb.getMonth()+1);GM_xmlhttpRequest({method:"GET",url:"/themes/"+cb,onload:function(cd){cc=(new DOMParser()).parseFromString(cd.responseText,"text/html").querySelector("[id*='theme-list']");if(cc){a.Storage.TLCList=cc.href.split("/posts/")[1];GM_setValue("rhBLAEO",a);}ca();}});}function c3(){var ca,cb,cc,cd,ce;cc=document.getElementsByClassName("panel-default")[0].getElementsByTagName("ul")[0].children;for(ca=0,cb=cc.length;ca<cb;++ca){cd=cc[ca];ce=parseInt(cd.firstElementChild.href.match(/\d+/)[0]);if(a.Storage.TLCGames.indexOf(ce)<0){a.Storage.TLCGames.push(ce);c5(cd);if(a.Storage.OwnedGames.indexOf(ce)>=0)c4(cd);}else if(a.Storage.OwnedGames.indexOf(ce)>=0)c4(cd);}c6(cc,"Beaten","#5cb85c",function(){c6(cc,"Completed","#5bc0de",function(){document.querySelector("[id*='counter']").innerHTML="<font size=\"4\"><b>"+cb+" Games</b></font>";GM_setValue("rhBLAEO",a);});});}function c4(ca){ca.insertAdjacentHTML("beforeend","<b style=\"color: #d9534f;\"> [Owned]</b>");}function c5(ca){ca.insertAdjacentHTML("beforeend","<b style=\"color: #555555;\"> [New]</b>");}function c6(ca,cb,cc,cd){var ce,cf,cg,ch;GM_xmlhttpRequest({method:"GET",url:"/users/"+a.Storage.UserID+"/games/"+cb.toLowerCase(),onload:function(ci){for(ce=0,cf=ca.length;ce<cf;++ce){cg=ca[ce];ch=cg.firstElementChild.href.match(/\d+/)[0];if((new RegExp("/app/"+ch)).exec(ci.responseText))cg.insertAdjacentHTML("beforeend","<b style=\"color: "+cc+";\"> ["+cb+"]</b>");}cd();}});}
